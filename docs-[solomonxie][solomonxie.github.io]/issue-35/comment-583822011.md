# 利用Haproxy实现Shadowsocks负载均衡

- 在家里树莓派上安装Haproxy作为前端入口，然后把流量分发给各个后端SS主机



## 树莓派本地Shadowsocks-client客户端安装与配置

```sh
# 由于国内无法正常用pip安装ss的python包，所以用这种方法安装：
$ sudo pip install https://github.com/shadowsocks/shadowsocks/archive/master.zip

# 创建客户端配置文件(自行操作）
$ touch ~/ss-local.json
$ vim ~/ss-local.json
```

客户端配置（注意local地址必须是0.0.0.0这样才能收到来自局域网的请求）：
```json
{
    "server":"服务器公网地址",
    "server_port": 服务器端口,
    "local_address":"0.0.0.0",
    "local_port":1080,
    "password":"ss密码",
    "timeout":600,
    "method":"加密方式"
}
```

开启客户端，也就是允许转发：
```sh
# 手动启动客户端（需要保持连接）
$ sslocal -c ~/ss-local.json -v

# 在命令行中验证
$ export all_proxy=socks5://0.0.0.0:1080
$ curl http://httpbin.org/ip
{
  "origin": "此处如果显示的是服务器地址就对了，如果是本机地址就没生效"
}
```


## Haproxy安装与配置

参考：https://tianws.github.io/skill/2019/07/11/gfw/

```sh
$ sudo apt install haproxy -y
$ sudo mv /etc/haproxy/haproxy.cfg /etc/haproxy/haproxy.cfg.bak # 备份
$ sudo vim /etc/haproxy/haproxy.cfg # 编辑配置文件
```

配置文件设置：
```ini
global
    log /dev/log local0
    log /dev/log local1 notice
    user root
    group root
    daemon

defaults
    log global
    mode tcp
    timeout connect 5s
    timeout client 5s
    timeout server 5s
    option      dontlognull
    option      redispatch
    retries     3

listen status
  bind *:1111
  mode  http
  stats refresh 30s
  stats uri /status
  stats realm Haproxy  
  stats auth admin:admin
  stats hide-version
  stats admin if TRUE

frontend shadowsocks-in
    mode tcp
    bind *:8388
    default_backend shadowsocks-out

backend shadowsocks-out
    mode tcp
    option      tcp-check
    balance roundrobin
    server  servername1    xxxxx1.com:8088  check
    server  servername2    xxxxx2.net:8080  check
    server  servername3    12.34.56.78:9999  check
    server  servername4    123.234.234.123:443  check
```

使用Haproxy:
```sh
sudo service haproxy start|stop|status|reload|restart|force-reload # 控制 haproxy 的运行
```