# ❖ 正式的介绍「Mutt」：命令行的邮件大师 (一文详解) [DRAFT]

为什么要用Mutt？
这个世界已经有了成百上千的漂亮邮件客户端，为什么还要用命令行里的？
其实说什么功能都没用。说到本质上，其实是一种Geek精神，一种爱折腾的精神，一种Customizability的精神。就像明明有WhatsApp，还要用IRC一样的精神；明明有Finder，还要用Ranger的精神。
在终端里待久了，会比较烦GUI，所以不管什么软件都会寻求终端的替代方案。
对于这个需求来说，在Linux的世界里，似乎就只有一个选择：Mutt。

Mutt的可配置性，强如Vim。配置起来也和Vim差不多，有专门的`~/.muttrc`供你配置软件本身。

需要理解的是：**Mutt本身是一个框架而已。收件、发件、编辑邮件等功能，是要通过搭配不同的程序来做到的。**



## Mutt的搭配方案

就像穿衣搭配一样，收件发件过滤邮件转发邮件各种东西都有很多种程序可以用，mutt怎么搭配呢？
常用选项有这些(User/Transport/Delivery)：
- MUA 收件：`fetchmail`或`getmail`
- MTA 发件：`sendmail`或`msmtp`或`postfix`。其中`msmtp`兼容强，`postfix`对国内不友好
- MDA 分类: `procmail`或`maildrop`
- 邮件编辑：VIM。

[参考邮件代理(功能分类)：Email agent (infrastructure) - Wikipedia](https://www.wikiwand.com/en/Email_agent_(infrastructure))

一般搭配是：
- 老式搭配：mutt + getmail + sendmail + procmail
- 新式搭配：mutt + fetchmail + msmtp + maildrop

但是maildrop不支持Mac，而procmail比较通用一点。所以这里我们用：
`mutt + fetchmail + msmtp + procmail`

安装：
```sh
# Mac
$ brew install mutt fetchmail msmtp procmail

# Ubuntu
$ sudo apt-get install mutt fetchmail msmtp procmail -y
```


Mutt或各个写协作程序在配置前都是不能使用的，学习曲线还是比较陡峭的，所以要做好准备去花好一段去了解和学习各个部件。

大概的配置流程是：
- 配置收件：`~/.fetchmailrc`
- 配置过滤：`~/.procmailrc`
- 配置发件：`~/.msmtprc`
- 配置mutt框架本身：`~/.muttrc`

注意：初学过程中，不要一上来就配置mutt。最好是先从各个部件开始：`收件->过滤邮件->阅读邮件->发件->mutt界面`，按照这种顺序。


## 收件：配置Fetchmail

> Fetchmail是由著名的《大教堂与集市》作者 Eric Steven Raymond 编写的。

Fetchmail是一个非常简单的收件程序，而且是`前台运行`、`一次性运行`的，意思是：你每次手动执行`fetchmail`命令，都是在前台一次收取完，程序就自动退出了，不是像一般邮件客户端一直在后台运行。
如果想后台运行，要么用cron定期收取，要么设为守护进程，要么用mutt。

> **注意：fetchmail只负责收件，而不负责存储！所以它是要调用另一个程序如`procmail`来进行存储的。**


fetchmail的配置文件为`~/.fetchmailrc`。然后文件权限最少要设置`chmod 600 ~/.fetchmailrc`

[参考：Using Fetchmail to Retrieve Email](https://www.linode.com/docs/email/clients/using-fetchmail-to-retrieve-email/)

比如我们要设置多个邮箱账户同时收取，那么配置如下：
```
poll pop.AAA.com protocol POP3 user "me@AAA.com" password "123"
poll pop.BBB.com protocol POP3 user "me" there with password "123" is falko here fetchall
poll pop.CCC.com protocol POP3 user "me" there with password "123" is till here keep
poll pop.DDD.com
  protocol POP3
  user "me"
  password "123"

# 全局选项
mimedecode
mda "/usr/local/bin/procmail"
```

其中，
- **各种参数可以不按顺序，也可以不在一行。** `空格`隔开每个参数，`poll`隔开每个账户。
- `here`, `there`, `with`, `is`等等，都不是关键词，随便写不影响参数。
- `poll`后面是邮件服务器的地址，一般是`pop.xxx.com`
- `protocol`后面是收件协议，一般是`pop`或`pop3`
- `user`后面是用户名，可以是username，也可以是邮箱地址
- `password`后面是密码
- 以上是必填，其它都不是必要的
-  四选一：`fetchall`, `nofetchall`, `keep`, `nokeep`
- `mimedecode`用来自动解码MIME
- `mda`后面指定本机安装的邮件过滤分类程序。如果不填，则收取的邮件在本地不会保存。可以用`$ which procmail`查一下路径。

配置完成后，可以运行`fetcmail -v`来看看是否有错误信息，如果能够正常显示很多行的收取信息，那么就能正确登录邮箱收取了。

但是fetchmail只负责收取，不负责“下载”部分，你找不到邮件存在哪了。
所以还需要配置MDA分类器，如`procmail`，才能看到下载后的邮件。


## 邮件过滤：配置Procmail

Procmail是单纯负责邮件的存储、过滤和分类的，一般配合`fetchmail`收件使用。

在Pipline中，fetchmail把收到的邮件全部传送到Procmail进行过滤筛选处理，然后Procmail就会**把邮件存到本地形成文件**，然后给邮件分类为工作、生活、重要、垃圾等。

当然，分类规则是自己可以指定的。可以根据发信人、主题、长度以及关键字 等对邮件进行排序、分类、整理。

[参考：Procmail](http://lifegoo.pluskid.org/wiki/Procmail.html)

Procmail 的配置文件是 `~/.procmailrc` ，记得改权限：`chmod 600 ~/.procmailrc`。
内容也非常简单，前面是邮件位置、日志等默认选项，后面则是一块一块的过滤规则：

```
MAILDIR=$HOME/Mail   #邮件存储地址
DEFAULT=$MAILDIR/inbox   #默认：收件箱
VERBOSE=off
LOGFILE=/tmp/procmaillog

# 某个垃圾邮件规则
:0
* ^From: webmaster@st\.zju\.edu\.cn
/dev/null    #垃圾文件的存储位置

# 其它所有都存到收件箱中
:0:
inbox/
```

其中，`$HOME/Mail`是设定的邮件存储位置。
我们需要手动创建`mkdir ~/Mail`，否则程序会报错。

配置好后，我们再测试一下，假设邮箱里有一封未读邮件，就会看到：
```sh
$ fetchmail
1 message for Jason@aliyun.com at pop3.aliyun.com (7833 octets).
reading message Jason@aliyun.com@pop3.aliyun.com:1 of 1 (7833 octets) flushed

$ tree ~/Mail
/Users/Jason/Mail
└── inbox
    ├── cur
    ├── new
    │   └── 1549706227.89809_0.Jason-mba.lan
    └── tmp
```

可以看到，一封新邮件保存到了`~/Mail/inbox/new/`中，文件为`1549706227.89809_0.Jason-mba.lan`。但是手动打开以后是这样的：

![image](https://user-images.githubusercontent.com/14041622/52519343-e3320980-2c94-11e9-8b15-2b8bee88908d.png)

这个实际上就是邮件的真面目：MIME格式(协议)的邮件源码。就像HTML一样，展示给我们的和背后的源码不一样。

那么怎么把这个类似HTML的MIME格式邮件解析为我们人能读懂的内容呢？
这个我们就要靠`mutt`自己了，mutt自身具备基本的MIME邮件解析功能（不包括HTML格式邮件读取）。

但是这里我们先不讲邮件阅读的问题，把它留在最后。



## 发件：配置msmtp

`msmtp`是作为替代`sendmail`发邮件程序的更好替代品。
msmtp的配置文件为`~/.msmtprc`，记得改权限：`chmod 600 ~/.msmtprc`
配置内容比收件还简单，因为发件永远比收件简单。

> Tip: 发件的服务器是`smtp`协议。收件才是`pop3`协议。

配置文件案例：
```
account default
  auth login
  host smtp.XXX.com
  port 587
  from ME@XXX.com
  user ME
  password passwd
  tls on
  tls_certcheck off

account Gmail
#.......

logfile /tmp/msmtp.log
```



## 主界面：配置Mutt

Mutt的配置文件为`~/.muttrc`，记得改权限：`chmod 600 ~/.muttrc`


案例：
```
# 通用设定
set use_from=yes
set envelope_from=yes
set move=yes    #移动已读邮件
set include #回复的时候调用原文
set charset="utf-8"
auto_view text/html   #自动显示HTML

# 发送者账号
set realname="Solomon Xie"
set from="solomonxie@aliyun.com"

# 分类邮箱
set mbox_type = Maildir #Mail box type
set folder = "$HOME/Mail"
set spoolfile = "$HOME/Mail/inbox" #INBOX
set mbox="$HOME/Mail/seen"  #Seen box
set record="$HOME/Mail/sent"  #Sent box
set postponed="$HOME/Mail/draft"  #Draft box

# 关联程序（需要自己用which命令确定一下）
set editor="vim -nw"
set sendmail="/usr/local/bin/msmtp"
```


## 极简配置

综合上面的四大配置文件，下面是我的四个文件的极简配置：

![image](https://user-images.githubusercontent.com/14041622/52519686-3a86a880-2c9a-11e9-9d80-6c63af25e20c.png)


现在我的目的是先让收发件运行起来，至于界面美化、快捷键设定等，我们以后再说，里面很有学问。


## Mutt主界面的基本操作

