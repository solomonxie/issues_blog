# Linux 命令行终端操作积累
## 积累终端命令行相关经验，包括Shell中的bash,zsh，终端中的Terminal, Mac Terminal.app,iTerm等

注意：这里说linux，linux之类的，其实在mac中也ok。只不过说起来和搜索起来方便而已。





## 命令行添加文字颜色
> 不是终端的颜色主题，只加了颜色主题但是文字还是同样颜色，其实没什么用。主要就是要类似于语法高亮的功能，要不然命令行里源源不断的一页一页的字冒出来实在不好读。

### 方案一：直接添加Terminal的配置文件
Mac中和Linux是一样的，直接在本用户的根目录添加一个`.bash_profile`文件写入配置，打开颜色开关即可。
```shell
$ vi ~/.bash_profile
export CLICOLOR=1
```
但是效果不佳，开关顶多加上了`ls`文件夹的颜色，没什么大用。如图：
![image](https://user-images.githubusercontent.com/14041622/35258738-783302ae-003c-11e8-9443-f65288c59c7c.png)
所以就需要再进一步找一个靠谱的解决方案。





## Bash shell / Zsh 里修改前缀 (隐藏用户@主机，添加Git分支名称)
> 每次在命令行里进入有git的文件夹，都没什么显示，不像网上其他人截屏出来的样子，就好奇怎么弄的。下面分bash和zsh两种方式分别来说。
`注：`这里都是使用的Mac Terminal.app做实验，Mac的iTerm或Linux上的终端没有做实验，但是操作不会有太大差异。

### 1. Bash的修改方法
其实特简单，还是在`~/.bash_profile`文件中添加：
```shell
$ vim ~/.bash_profile

# Shows Git branch name in prompt.
parse_git_branch() {
  git branch 2> /dev/null | sed -e '/^[^*]/d' -e 's/* \(.*\)/ (\1)/'
}
export PS1="\u@\h \W\[\033[32m\]\$(parse_git_branch)\[\033[00m\] $ "
# Or hide User @ Name (still with git branch name)
# export PS1="\W\[\033[32m\]\$(parse_git_branch)\[\033[00m\] $ "
```
效果如下：
![image](https://user-images.githubusercontent.com/14041622/35312980-08149de4-00f9-11e8-8eee-cf6f955f6957.png)

### 2. Zsh的修改方法
类似于Bash，在`~/.zshrc`这个文件中修改，打开后，随便找个位置（最好靠上面一点方便查看）加上一行`DEFAULT_USER=$USER `即可。如果为zsh安装了`Oh my zsh`这个工具（一般玩zsh第一步就是安装它），这里就不需要单独处理像Bash一样手动编程添加Git名称了，因为会自动出现。进入zsh后，可以看到效果如下：
![image](https://user-images.githubusercontent.com/14041622/35313348-c698b510-00fa-11e8-86ad-b6c81ddd8d8c.png)

当然，我这里的Git分支还配上了图标和颜色等，这都需要给终端（这里是Mac Terminal.app)安装相应配色方案，我用的是著名的`Solarized Dark`配色方案。具体配色和字体问题（字体用来支持图标，因为那些图标的本质是文字），需要专开一篇来说。





## 安装并配置zsh
> `zsh`原称为**Z Shell**。也是一种shell，兼容最常用的bash这种shell的命令和操作，并且有很多增强，超强的订制性。查来查去，bash虽然很标准，但是自己日常的话还是不要太偏执，力求简单方便的工具更好，所以就玩弄起了zsh。超漂亮又简单,也很好上手。

Mac原生就安装了zsh，linux的话需要安装一下，简单如`sudo apt-get install zsh`这样就安装好了。
可以先通过`cat /etc/shells`查看自己有哪些shell，一般都会有很多种。
使用方法很简单，直接在命令行里输入`zsh`就开始使用了。不过要变成每次打开终端默认使用zsh，则需要改配置。
### 安装`Oh My Zsh`
原本zsh就是很强大，但是配置超难，直到**Oh my zsh**工具出现，一切zsh的配置都变简单了。所以这是用zsh的必备工具，安装只需一句话：
```shell
sudo  curl -L https://raw.github.com/robbyrussell/oh-my-zsh/master/tools/install.sh | sh 
```
屏幕显示这个图，就算安装好了：
![image](https://user-images.githubusercontent.com/14041622/35263685-c564c77a-0054-11e8-9152-81b2071c28f5.png)
然后再打开终端，感觉一切都变了：直接进入zsh，命令行前一大串的用户名主机等都被隐藏了，进入git文件夹时前面也都加上了`git (master)`这样的带颜色分支字样，按Tab自动补全时也不用区分大小写了(太棒了)。。。如下图
![image](https://user-images.githubusercontent.com/14041622/35263813-3cbde8a6-0055-11e8-9437-da2506352be4.png)

有一点需要注意，安装完oh my zsh后，机子(Mac)上的Terminal会变成默认打开就进入zsh。如果不习惯的话，可以改回默认先。Mac的Terminal在设置里将`shell open with`改成`/bin/bash`就好了：
![image](https://user-images.githubusercontent.com/14041622/35265450-16b0e4a0-005b-11e8-9839-5a15c4eba114.png)





## Mac终端配色方案 Color schemes

要想配置出这种好看的方案，标配就是：`zsh` + `Meslo字体` + `Soloarized Dark显示方案` + `Agnoster配色方案`。网上有很多文章介绍，不过这里也简单总结个cheatsheet方便以后用。
注：之前已经写了zsh和基本工具`oh my zsh`的安装方法了。后面都是在此基础上。
![image](https://user-images.githubusercontent.com/14041622/35314446-2b49018a-0101-11e8-94bd-2f0d06322cbe.png)

### 1. 安装Solarized显示方案 (仅用于本地客户端应用)
显示方案主要负责修饰命令行前缀，隐藏user@host，识别git文件夹，添加图标，命令高亮等。
去`Solarized`官网下载一个[zip压缩包](http://ethanschoonover.com/solarized/files/solarized.zip)。压缩包中包含了这种颜色方案应用在各种各样平台、终端、软件的配置文件。找到自己用的终端文件夹。如我用的是Mac Terminal，那么就在`osx-terminal.app-colors-solarized`这个文件夹，将里面的`Solarized Dark ansi.terminal`文件导入到终端。如下图：
![image](https://user-images.githubusercontent.com/14041622/35315201-f8f593ec-0105-11e8-9a9b-1b67b9385cbd.png)
![image](https://user-images.githubusercontent.com/14041622/35315223-171b34b2-0106-11e8-9c7d-4c0e3f4a3895.png)
在终端的配置里导入配色方案后，就出现了`Solarized Dark`选项，将其设为默认，重新打开终端，就出现基本的配色方案了。

### 2. 安装字体 （仅用于本地客户端应用）
Solarized配色包需要`Meslo LG M Regular for Powerline`这种字体才能显示各种特殊字符（图标），下载好ttf字体文件并安装。下载链接在这里[https://github.com/powerline/fonts/raw/master/Meslo%20Slashed/Meslo%20LG%20M%20Regular%20for%20Powerline.ttf](https://github.com/powerline/fonts/raw/master/Meslo%20Slashed/Meslo%20LG%20M%20Regular%20for%20Powerline.ttf)
装好以后，可以在终端中输入这个来测试是否成功：
```echo "\ue0b0 \u00b1 \ue0a0 \u27a6 \u2718 \u26a1 \u2699"```
如果能正常显示所有图标，则安装成功。
然后打开终端的偏好设置，在当前`Solarized`的配色方案下，找到字体选项，选择`Meslo LG M Regular for Powerline`字体，成功。
![image](https://user-images.githubusercontent.com/14041622/35315371-0582e28a-0107-11e8-8336-b2d2c7e8c75b.png)

### 3. 设定Agnoster配色主题
不同于如Solarized显示方案，配色主题单纯负责颜色问题。
这个需要在Zsh配置文件`~/.zshrc`中配置，由于`agnoster`是Oh My Zsh工具自带，所以无需安装额外文件直接修改选项。
找到`~/.zshrc`文件，将`ZSH_THEME`变量改成`agnoster`，保存并重新打开终端即可。如下图：
![image](https://user-images.githubusercontent.com/14041622/35315665-9ef20526-0108-11e8-9726-c4d38fbd37c7.png)

最后，我在Mac终端上显示效果如下：
![image](https://user-images.githubusercontent.com/14041622/35315432-55a881c0-0107-11e8-93ed-0a179044f1aa.png)
好像颜色哪里差了点，是因为它原生在iTerm终端才能发挥完全效果。效果如下：
![image](https://user-images.githubusercontent.com/14041622/35315453-74bad900-0107-11e8-858a-eeb45c980857.png)

iTerm的配置方法和Terminal.app非常相似，自己在偏好设置中采用类似的操作即可。
关于其它Oh My Zsh自带的色彩主题，可以到这里看效果：
[https://github.com/robbyrussell/oh-my-zsh/wiki/Themes](https://github.com/robbyrussell/oh-my-zsh/wiki/Themes)





## 终端里添加快捷路径
> 一般要一路cd进入五层以上的目录，是真的有点头疼。所以研究了下有没有设置快捷路径的方法

1. 方法一：设置系统变量
通过在`~/.bash_profile`或`~/.zshrc`里面设置`export DIR="/path/path/path"'这种来设置变量，然后引用是通过`$var`来引用。
但是每次都加`$`确实有点不爽，好像也没达到什么特别快捷的方法。
2. 方法二：alias
直接设置`alias topath="cd /path/path/path"`这种来设置别名，每次在终端直接输入类似topath，回车即可。这种方式是可取的。
为了保证可管理性，建议所有的alias别名都放到`~/.bash_profile`这种用户自定义的终端配置文件里，方便以后备份移植。





## Zsh 常用插件
> zsh有了各种插件后才真是如虎添翼，各种命令高亮，自动补全，命令参数辅助等。

### zsh插件安装方法
各种插件的安装方法各异，有的直接将插件文件夹拷贝到`~/.oh-my-zsh/custom/plugins`目录中，然后在`~/.zshrc`中的`plugins`数组中加入插件名即可；有的则需要配合别的工具并在`~/.zshrc`中加入别的命令。以下是几个常用的。
安装时经常会看到一些`$ZSH_xx`变量，这些都是zsh或oh my zsh设置的各种变量，便于插件运用。我们安装插件时也可以用这些变量安装，如插件保存的位置一般为`$ZSH_CUSTOM/plugins/插件文件夹名/`。

### Oh my zsh自带插件
自带插件在安装时就已经存在了，默认是只开启了git一个插件。其它的话也很简单，只需要在`~/.zshrc`文件中添加引用即可。打开文件找到`plugins`数组，然后把插件名加入数组即算开启。
如下图：
![image](https://user-images.githubusercontent.com/14041622/35327373-6c0bd3fe-0134-11e8-832c-3a7bab28e17f.png)

目前已经有的自带插件在官网Github中可以看到，[https://github.com/robbyrussell/oh-my-zsh/tree/master/plugins](https://github.com/robbyrussell/oh-my-zsh/tree/master/plugins)。
凡是这里有的，都可以立刻生效。

### Zsh命令自动补全插件 [zsh-autosuggestions](https://github.com/zsh-users/zsh-autosuggestions)
这里利用Oh my zsh的方法安装。直接一句话命令行里下载并移动到oh my zsh目录中：
```shell
git clone https://github.com/zsh-users/zsh-autosuggestions $ZSH_CUSTOM/plugins/zsh-autosuggestions
```
然后在`~/.zshrc`文件中找到plugins数组，加入`zsh-autosuggestions`名字，重新打开终端即可。

### Zsh命令语法高亮插件 [zsh-syntax-highlighting](https://github.com/zsh-users/zsh-syntax-highlighting)
将插件下载到oh my zsh的插件目录下的该新建插件同名文件夹中
```shell
git clone https://github.com/zsh-users/zsh-syntax-highlighting.git $ZSH_CUSTOM/plugins/zsh-syntax-highlighting
```
编辑`~/.zshrc`文件将然后将插件引用命令写入该文件最后一行（必须）
```
# Note the source command must be at the end of .zshrc
source "$ZSH_CUSTOM/plugins/zsh-syntax-highlighting/zsh-syntax-highlighting.zsh"
```
保存重新打开即可看到高亮的命令行了。





### 终端里用Sublime Text或其他应用程序打开文件
Mac下的Sublime Text的位置是`/Applications/Sublime\ Text.app/Contents/SharedSupport/bin/subl`
所以我们直接用alias别名引用它就好了。
Bash的话在`~/.bash_profile`里，zsh的话在`~/.zshrc`里，直接加入这句话：
```
alias subl="/Applications/Sublime\ Text.app/Contents/SharedSupport/bin/subl"
```
然后就可以直接命令行里打开编辑器了：
```
subl ~/readme.txt
```
执行后会弹出Sublime Text编辑器，并打开readme.txt文件。

**同理，换成其它编辑器，或在其它系统里，也是这样修改流程**






## ffmpeg 超强视频处理程序
> 开源视频处理几乎必用的一个程序，功能强大。

## Installation

```
# for Ubuntu 14.04 (no need to install on 15.04)
sudo add-apt-repository ppa:mc3man/trusty-media
sudo apt-get update
sudo apt-get dist-upgrade
sudo apt-get install ffmpeg -y
```

## 以最低CPU优先率执行命令

```
nice -19 ffmpeg 各种参数
```

## .webm to .mp4

```
nice -19 ffmpeg -i input.webm -c:v libx264 -crf 20 -c:a aac -strict experimental out.mp4
```

## Split Video

```
# 不转码截取片段（）
nice -19 ffmpeg -i "input.mp4" -ss 00:03:25 -to 00:05:42 -c copy "output.mp4"
```

## 调整音频与视频匹配不上的问题

### 方法1

```
nice -19 ffmpeg -i "input.mp4" -itsoffset 2.0 -i "input.mp4" -vcodec copy -acodec copy -map 0:0 -map 1:1 "output.mp4"
```

### 方法2: 一开始就分开截取音频视频 然后再合并

```
# ...
```

ffmpeg的参数顺序很重要, 不同的顺序造成截然不同的结果

## 切割视频

```
# 从指定开始点到指定结束点
ffmpeg -i 文件名 -ss 01:00:00 -t 00:06:00  -vcodec copy -acodec copy 输出文件名
ffmpeg -i 文件名 -ss 00:01:00 -to 00:02:00 -c copy 输出文件名
# 从指定开始点到指定时长
ffmpeg -ss 00:01:00 -i 文件名 -to 00:02:00 -c copy 输出文件名
# 调整音频匹配不上的问题 #方法1
ffmpeg -i "test.mp4" -itsoffset 2.0 -i "test.mp4" -vcodec copy -acodec copy -map 0:0 -map 1:1 "new.mp4"

# 调整音频匹配不上的问题 #方法2: 一开始就分开截取音频视频 然后再合并
# 
```





## cd命令常用技巧
- `cd ~`  进入用户主目录，`cd 空格`也行；
- `cd -`  返回进前一个所在目录；
- `cd ..`  返回上级目录；
- `cd ../..`  返回上两级目录；
- `cd !$`  把上个命令的参数作为cd参数使用





## rm 删除文件和文件夹
- `rm 文件名`删除文件
- `rm -rf 文件夹` 删除文件夹及其内所有文件





# 修改终端默认的shell
之前说过了，一般终端的默认Shell只要在终端应用如Terminal.app,iTerm2等的系统设置里直接改就好了。
但是如果我们要用ssh登录服务器就不能这么设置了，需要用到`chsh`这个命令。很简单
如果不懂的话，直接 `man chsh`就可以看到很简单的描述--改变登录shell。
首先要查到当前机器有哪些以安装的shell，`cat /etc/shells`。
![image](https://user-images.githubusercontent.com/14041622/35557228-749dbabe-05df-11e8-94a5-1311fcb87c62.png)
我的默认有这些，可以看到zsh位于`/bin/zsh`，那么如果想要将zsh改为默认，就直接在终端里输入：
```
chsh -s /bin/zsh
```
即可达到修改默认终端的效果。如果是ssh连接服务器的话，需要重连才能看到效果。





## Mac在终端上的快捷键
> 一开始是为了找翻屏（上下滚动）的快捷键，Windows和Linux上一般PageUp, PageDown即可，Macbook上没有这两个键，所以还挺难找的。后来查了一系列其它的终端快捷键，如下：

- `Cmd+Up` 向上滚动
- `Cmd+Dn` 向下滚动
- `Fn+Left` 和`Ctrl+A`一样，移到命令行最左端
- `Fn+Right` 和 `Ctrl+E`一样，移动的命令行最右端
- `Ctrl+U` 删除当前命令行
- `Ctrl+K` 删除当前光标后的所有内容





## Bash里读取Json数据
查看Stackovervlow, 发现[答案](https://stackoverflow.com/questions/1955505/parsing-json-with-unix-tools)，既可以使用`sed+awk`来自己写解析读取json，也可以通过引用python方法来更方便的解析。推荐python方法，如下：
```bash
echo '{"hostname":"test","domainname":"example.com"}' | python -c 'import json,sys;obj=json.load(sys.stdin);print obj[0]["hostname"]'
```
由于*nix都原生带有python，所以这么执行是没问题的。而且一般也不用考虑到执行速度问题。





# Bash所有键盘快捷键
[菜鸟教程](http://www.runoob.com/w3cnote/bash-shortcut.html)





# Linux 创建多级目录 | 多层次文件夹
- `mkdir <folder>` 创建单层文件夹, 比如`mkdir ./src`。不能创建多层，不能重复创建
- `mkdir -p <path>` 创建多层次文件夹，可以重复创建同一个文件夹。如`mkdir -p ./src/s/e/w/asdf`





# 复制某文件内容到剪切板 `pbcopy`

```shell
cat ~/file-name.txt | pbcopy
```





## 查看本地存储空间情况

### `$ df -h`就可以查看本地各处的存储情况了。下图是我的树莓派存储：
![image](https://user-images.githubusercontent.com/14041622/35480902-b5b50f3a-0453-11e8-892e-d1f9be0ee8d6.png)






# `scp`命令在服务器上传下载文件






# 命令行里打印日期
```shell
# 注意是反引号 因为是要执行date命令
echo `date`   

# 一个好用的技巧，快捷键commit
alias gc = "git add . && git commit -m \"`date`\" "
```





# Linux 定时任务 `crontab`
运行`crontab -e`后会自动跳进程序，在最底下一行写入执行命令，必须要按照格式写。
格式是`* * * * * 命令`，其中前五个星号分别代表着第几分钟、第几小时、每月第几日、哪个月、星期几。要按照顺序替换*为一个数字，如果保持*，则表示任意。
*还可以加运算符：
[参考文章](https://segmentfault.com/a/1190000007478002)
```
*:任何时间
/:每隔多久
-:连续时间
,:不连续的时间
```
[参考视频](https://www.youtube.com/watch?v=QZJ1drMQz1A)


```shell
# 每2分钟执行
*/2 * * * * echo "hello" >> ~/test.txt

# 每天执行
** 

```





# Linux 设计系统时区和时间

把程序运行在树莓派上时，获取的时间默认是美国的，这样记录日志之类的东西也都是美国时间会容易混淆。所以需要在命令行里修改系统时区。

### 改时区
我们在`/usr/share/zoneinfo`这个文件夹里可以看到各种各样的国家和时区，找到自己的时区后拷贝到`/etc/localtime`即可改变时区

```shell
# 中国是ROC
sudo cp /usr/share/zoneinfo/ROC /etc/localtime

# 验证
date
```

### 改时间
一般其实不需要改时间，联网的话默认是从网上获取的。
如果要改，[参考这篇文章](https://www.garron.me/en/linux/set-time-date-timezone-ntp-linux-shell-gnome-command-line.html)





# 使服务器上的任务不间断运行
> 通过ssh登录服务器运行一个python脚本，想让它24小时不间断运行。可是一旦我退出ssh，整个程序就断了。这是由于ssh的session特性——它本身就是一个session，连接上开启session，断开ssh连接则关闭session，关闭时所有你在这个session里运行的东西都会被中断。

### 关于ssh关闭连接就关闭运行程序的问题，[在这里可以看到一些解决方案](https://askubuntu.com/questions/8653/how-to-keep-processes-running-after-ending-ssh-session)。

## 解决方案一：`tmux`

很幸运，在学习怎么把vim分屏浏览时知道了tmux，然后看tmux视频时学到：原来ssh是这样的特性，断开就会停止所有之前连接ssh期间运行的所有processes，而tmux的核心业务不在于把屏幕分成几块好看，而是它能保存session！而且还能多端实时直播session！

### 解决方案二：`nohup`
网上一般说到不间断任务，一般也都会先提到这个，可以说是常规方案。

### 解决方案三：`screen`或`byobu`
这据说是现在更常用的方法，[参考文章](https://www.howtogeek.com/howto/ubuntu/keep-your-ssh-session-running-when-you-disconnect/)。

### 解决方案四：`disown`
据说的最简单方案：在命令后加`&`或者用`ctrl+z`把任务转到后台，然后用`disown -a`将任务解除与当前session的关联（意思就是当前session关闭也不影响它）





# `tmux`的超绝便利
> 上面提到服务器的任务不间断运行，就是利用了tmux的特性。就是说，一般ssh是断开就会停止所有之前连接ssh期间运行的所有processes，而tmux的核心业务不在于把屏幕分成几块好看，而是它能保存session！而且还能多端实时直播session！

了解tmux的安装和使用已经理解，这个[短视频](https://www.youtube.com/watch?v=BHhA_ZKjyxo)足矣！如果想试试tmux的session共享，让别的机器或别人像直播一样看你在命令行里打字、操作，也用tmux一句话即可，参考[这个视频](https://www.youtube.com/watch?v=norO25P7xHg)。

我万万没想到，将vim打造成IDE、将脚本不间断运行、让任务运行状态多处可观看的tmux，是这么简单。
一句`sudo apt-get install tmux`就安装好，一句`tmux`就开启，一句`tmux new -s <session-name>`就可以创建和保存session。超绝！

常用操作快捷键如下(摘自上面的视频)：
```
# session management
tmux ls (or tmux list-sessions)
tmux new -s session-name
Ctrl-b d Detach from session
tmux attach -t [session name]
tmux kill-session -t session-name

Ctrl-b c Create new window
Ctrl-b d Detach current client
Ctrl-b l Move to previously selected window
Ctrl-b n Move to the next window
Ctrl-b p Move to the previous window
Ctrl-b & Kill the current window
Ctrl-b , Rename the current window
Ctrl-b q Show pane numbers (used to switch between panes)
Ctrl-b o Switch to the next pane
Ctrl-b ? List all keybindings

# moving between windows
Ctrl-b n (Move to the next window)
Ctrl-b p (Move to the previous window)
Ctrl-b l (Move to the previously selected window)
Ctrl-b w (List all windows / window numbers)
Ctrl-b window number (Move to the specified window number, the
default bindings are from 0 -- 9)

# Tiling commands
Ctrl-b % (Split the window vertically)
CTRL-b " (Split window horizontally)
Ctrl-b o (Goto next pane)
Ctrl-b q (Show pane numbers, when the numbers show up type the key to go to that pane)
Ctrl-b { (Move the current pane left)
Ctrl-b } (Move the current pane right)

# Make a pane its own window
Ctrl-b : "break-pane"

# add to ~/.tmux.conf
bind | split-window -h
bind - split-window -v
```





# `tail`命令实时监控某文件变化
> 一般我们在程序生成log日志时，会想到用`cat`去查看内容。但是要想在程序运行过程中实时查看内容的变化，cat就不够好了，总不能手动一遍一遍去查吧。`tail`命令就可以解决这个问题，它让你像看直播看文件内容。

![screencast 2018-02-16 23-18-15](https://user-images.githubusercontent.com/14041622/36314429-d0ef2634-136f-11e8-8a14-bcbd04594dfd.gif)



