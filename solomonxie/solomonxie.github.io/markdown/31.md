# AWS为首的云服务器实战钻研
> Amazon Web Services是个真心强大靠谱的真·云服务器。只是玩好了它都可以被人敬仰，可是却真的不很容易配置，服务也太多。所以在这里开一篇，以供随时记录解决方案和发掘过程。
另外，附带性的会有一些DigitalOcean等的其它服务商方案。





# EC2的傻瓜式初始配置方案
> AWS 的服务海洋里面，EC2是最常见最常用的一个。也就是平时我们租用云端服务器最常用的虚拟主机，可以让你把网站代码、数据库等等全都部署在上面，然后用户直接连接这个虚拟主机。相对于其它aws的邮箱、数据库、语音等云服务来说，EC2是一个大杂烩，也是个通用平台，做什么都行，看自己。

1. 登录AWS控制后台，在服务列表中选择EC2 -> 左侧菜单Instances -> Launch Instance
2. 选择合适的映像，推荐社区版的映像：
   社区版有更多Linux发行版，在这里推荐选择ubuntu/images/hvm-ssd/ubuntu-trusty-14.04-amd64-server-20160114.5 ebs hvm
3. 选t2.micro类型的instance，其中会清晰标记这个是免费的
4. 设置详细：全部保持默认就行了
5. 添加存储盘：免费的是20G以内，一般默认的8G足够用
6. Tag可加可不加
7. 安全组：根据需求后期可改，内容较多
8. 综览及确认
9. 选择密钥
   必须要有，创建新的或选择已有的。
   如果这里没创建，则以后ssh登录不了。
10. 用SSH登录
    - 用Linux Shell的SSH命令登录：
      `ssh -i "私有密钥文件路径.pem" 用户名@实例的公网IP`
      其中.pem文件是私有密钥，输入路径即可;
      如果是ubuntu的映像，默认用户名是`ubuntu`，
      如果是AWS定制的映像，默认用户名是`ec2-user`;
    - 用Windows的Putty软件登陆：
      需要先用puttygen.exe把`.pem`私钥文件转换为`.ppk`文件，
      然后在菜单`connection -> SSH -> Auth`中，把文件路径填上，
      然后回到主菜单点击连接即可。





# Shadowsocks在AWS EC2运行时的网关设置 (待验证)
```
Security Groups -> Inbound -> Edit -> Add -> Custom TCP Rule, TCP, 8000 - 9000, 0.0.0.0/0
Security Groups -> Inbound -> Edit -> All traffic, All, All, 0.0.0.0/0
```





# Shadowsocks 服务器安装

1.创建服务器
2.创建时选择SSH Key，上传本地制作的密钥文件，如`~/.ssh/id_rsa.pub`
3.记住本地SSH Key密钥的访问密码，这样每次登录服务器只要输入它就行了。
4.打开终端, 利用SSH连接,`ssh root@ip-address`
```shell
sudo apt-get update
sudo apt-get install python-pip -y
# 如果提示需要升级pip
# pip install --upgrade pip
pip install shadowsocks
sudo vi /etc/shadowsocks.json
{
    "server":"0.0.0.0",
    "server_port": 1111,
    "password":"aaaaaaaa",
    "local_address":"127.0.0.1",
    "method":"aes-256-cfb",
    "local_port":1080,
    "timeout":300,
    "fast_open":false
}
```

sudo ssserver -c /etc/shadowsocks.json -d start

如果遇到 permission denied错误, 试一下改变下面文件权限:
```shell
sudo chmod 777 /var/run/shadowsocks.pid
sudo chmod 777 /var/log/shadowsocks.log
```
如果还是不行，那么试试直接按照ssserver的路径启动：
```
sudo /usr/local/bin/ssserver -c /etc/shadowsocks.json -d start
```
![image](https://user-images.githubusercontent.com/14041622/35665785-835dfcf6-0762-11e8-9d84-d730cec37146.png)






# Shadowsocks 创建好后无法访问
如果开着ss，打不开谷歌，那么最先尝试的是用ssh连接。如果连接成功，那么说明服务器和网络都没问题。剩下只是配置的事了。
1. 检查防火墙配置。亚马逊AWS的防火墙是很严格的，所以多半都会卡在这。
如果是AWS的Lightsails的话，直接在Networking配置里，开启全部端口，如下图：
![image](https://user-images.githubusercontent.com/14041622/35667037-20aa38cc-0767-11e8-814e-504fae373de4.png)
或者谨慎点，在默认配置的基础上，添加自己连接的端口：
![image](https://user-images.githubusercontent.com/14041622/35765788-323cf50c-0906-11e8-8031-897d4264767f.png)

2. 还不行的话，就在命令行里主动添加防火墙设置：
```shell
# 下载防火墙设置的软件
sudo apt-get install firewalld
# 开启相应的端口
sudo firewall-cmd --zone=public --add-port=你当前服务器的IP地址/tcp --permanent
sudo firewall-cmd --zone=public --add-port=你当前服务器的IP地址/udp --permanent
```
改好后，就可以通过`cat /etc/firewalld/zones/public.xml`这个文件里看到，刚刚的防火墙设置已经生效了。
3. 如果还不行，就试试这招，把ss配置文件的服务器段IP改为`0.0.0.0`（如果已经是这个设置则反之设置成服务器IP地址），然后保存，并重启ssserver，`sudo ssserver -c /etc/shadowsocks.json -d restart`。如下图：
![image](https://user-images.githubusercontent.com/14041622/35667184-a97dc4d4-0767-11e8-9ea7-eff766e65dd8.png)






# Shadowsock多用户配置

```json
{
    "server": "0.0.0.0",
    "port_password": {
        "8381": "foobar1",
        "8382": "foobar2",
        "8383": "foobar3",
        "8384": "foobar4"
    },
    "timeout": 300,
    "method": "aes-256-cfb"
}
```





# AWS Lightsail 无法ping通
ping某一个服务器，是需要服务器防火墙允许ICMP协议的数据包的。经查阅，AWS的所有服务是默认关闭icmp的。
除独立的Lightsail外，其它AWS服务都可以在安全组中设置防火墙开启icmp。
然而Lightsail的防火墙设置页面，并没有icmp选项，官方也没有任何相关解决方案。

    因此目前来说，也就是无法使用ping来测试服务器连接的了。





## 搭建的SS服务开始几天很快然后就经常掉线，速度也变慢
不管是在DigitalOcean还是AWS的Lightsail搭建ss服务，都有这个问题。
都是出现在我将ip绑定到阿里云的域名之后，在想是不是和阿里云的域名有关系。出现掉线的情况后，无论是ip直连还是用域名连，情况都没有改善，所以怀疑是不是只要在阿里云绑定了域名和ip，就会被更严格的监控到使用ss服务，导致经常掉线。





# AWS各国节点测试
根据[CloudPing](http://www.cloudping.info/)的测试，得出如下结果：
![image](https://user-images.githubusercontent.com/14041622/35795505-50bc8f6c-0a94-11e8-89fa-e8f589be259c.png)
除了加拿大没试过外，其它亲测完全属实，新加坡远快于日本和韩国。





# Shadowsocks开机启动
参考了好几篇文章，怎么说的都有，看起来靠谱的不多。最后挑了一个最简单的方法，生效了。[原文在这里](https://www.zybuluo.com/Hederahelix/note/245179)。
编辑`rc.local`开机启动项：
```
sudo vi /etc/rc.local
ssserver -c /etc/shadowsocks.json -d start
```
保存退出，用`sudo reboot`重启，有效。





# 各服务商的各国节点测试（不定期更新）
自从今天发现命令行里可以运行ookla的`speedtest`，就赶快到自己的树莓派、国外租的主机查看连接网速。之前一直用shadowsocks觉得网速慢的时候，总是怀疑有可能节点没选好，一会儿东京，一会儿新加坡，一会儿加拿大，可还是有问题。

## AWS Lightsail 主机 -- Singapore 节点
下载速度近500M/s，上传速度150M/s，这是什么级别？!
![snip20180209_70](https://user-images.githubusercontent.com/14041622/36030420-1d5b99f0-0de2-11e8-9037-0db28113f53d.png)

> 在网上看到过一个帖子说得很对，不管怎么测试，还有什么比Youtube 1080P更有说服力呢？

看到这个，才明白原来服务器本地访问的速度和上传的速度再快，也敌不过传输过程中的丢失。。
另外，我是在本机连接服务器访问youtube的，我本机的测速是15M/s，宽带的带宽是100M。
![image](https://user-images.githubusercontent.com/14041622/36031150-b886ea72-0de4-11e8-8675-781ab022ac76.png)
此时我本机访问bilibili视频的速度比访问youtube快了一倍，如下：
![image](https://user-images.githubusercontent.com/14041622/36031623-4f78fd70-0de6-11e8-8880-1898a79d7d1d.png)









# `iftop`命令统计服务器网络流量运行情况
[参考文章](https://segmentfault.com/a/1190000002797441)
![image](https://user-images.githubusercontent.com/14041622/36032772-0355e7ba-0dea-11e8-8014-b44463277bff.png)







# Shadowsocks命令行中的本地客户端配置
> 有时候想让树莓派访问一些屏蔽的网址，所以只能用命令行的客户端。

[参考文章](http://www.jeyzhang.com/how-to-install-and-setup-shadowsocks-client-in-different-os.html)

简单说就是：
```shell
sudo apt-get install m2crypto
sudo pip install shadowsocks

#启动Shadowsocks
sslocal -s 服务器域名或IP -p 服务器端口号 -k “密码” -l 1080 -t 600 -m rc4-md5 
```

当然，启动方式还有从配置文件的方法。
首先在某处创建配置文件，比如`~/.shadowsocks-client.json`，内容如下：
```javascript
{
    "server":"服务器IP地址",
    "server_port": 服务器端口,
    "password":"服务器密码",
    "local_port": 1080,
    "timeout": 600,
    "method":"aes-256-cfb"
}
```
然后用这个命令启动：`sslocal -c ~/.shadowsocks-client.json`

## 启动之后
启动之后，就不要关闭命令，只能打开另一个命令行窗口操作。
现在命令行直接访问网络其实没什么变化，IP还是自己的。
因为需要连接本地的1080端口（刚才在shadowsocks里面设置了，将代理映射到本地的1080端口），通过连接本地1080端口作为代理访问网络。

比如`curl`获取网络内容，那么就需要用curl的代理参数访问，如下：
```
curl -x http://127.0.0.1:1080 httpbin.org/ip
```

## 在Mac中命令行走代理
如果是配置的Shadowsocks，那么在GUI或命令行方式启动了shadowsocks的情况下，需要找到正确的本地映射端口。在GUI的设置页面里面可以找到HTTP的映射端口：
![image](https://user-images.githubusercontent.com/14041622/36645118-1e4b0052-1a9f-11e8-84ab-74483827d65f.png)
那么，比如使用curl时，就应当用http如此访问：
`curl -x http://127.0.0.1:1087 httpbin.org/ip`
其它软件也同理，选择http方式的该地址和该端口，就能正确连接了！


